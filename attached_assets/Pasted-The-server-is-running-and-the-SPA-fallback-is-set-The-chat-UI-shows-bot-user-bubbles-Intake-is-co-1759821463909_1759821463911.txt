The server is running and the SPA fallback is set. The chat UI shows bot/user bubbles.

Intake is conversational (one question at a time), but the flow is broken.

Problems to fix (clearly reproducible)

Empty bot message after valid input

When I answer a step correctly (e.g., full name, then email), instead of receiving the next question, a blank bot bubble appears.

Likely causes: server returns an empty prompt or does not advance step index, so the client renders nothing or re-renders the same step.

Options not shown for choice steps

For steps like age_band / job_nature / sector, no chip options are displayed.

Likely causes: API payload missing type and/or options, or the client renderer doesn’t switch on type to draw chips.

Country step shows “select from list” but no dropdown appears

I see the message “Please select a country from the list”, but no list or search dropdown is rendered.

I need a full ISO-3166 world countries list with a searchable dropdown. Arabic labels when UI is Arabic, English labels when UI is English. Store the selected country code/value consistently.

Validation loops

On invalid input the validation message shows correctly, but on valid input the flow doesn’t proceed (ties back to #1).

Hard constraints

Do not add new frameworks or databases. Keep the current architecture and files.

Only touch server/index.js (intake logic/payload) and the existing client chat script (e.g., public/app.js or the current client page) to render inputs.

Keep the bilingual behavior (AR/EN with RTL).

No classifier/clarifier modules now.

What to implement exactly

A) Server: canonical intake model & payload
Implement a simple in-memory intake state and a fixed question catalog inside server/index.js (no extra files unless you really need a public/countries.json). Use this step order:

INTAKE_ORDER = [
  "name_full",
  "email",
  "age_band",
  "country",
  "job_nature",
  "experience_years_band",
  "job_title_exact",
  "sector",
  "learning_reason"
];


For each key define:

type ∈ text | chips | country

prompt[ar] and prompt[en] (must never be empty)

options[ar] and options[en] for chips / country

validation_error[ar|en] where needed (e.g., name/email)

API contract for the chat client (make the server return exactly this):

// Next question
{
  "stepKey": "country",
  "type": "country",
  "prompt": "Please select a country from the list:",
  "options": ["Egypt","Saudi Arabia","..."],        // or objects if you prefer {code,label}
  "lang": "en"
}

// Validation error (stay on the same step)
{
  "error": true,
  "message": "Invalid email address."
}

// Flow done
{ "done": true }


Server rules:

On valid input: store value, increment step index, return the next step payload.

On invalid: return {error:true,message:...}; do not increment.

Never return an empty prompt. If something’s missing, send a safe error message.

B) Countries: full world list with search

Provide the full ISO-3166 list. EITHER:

Inline a static array in server/index.js (OK), or

Add a single static file public/countries.json and load it on the client (also OK).

When UI lang is ar, show Arabic labels; when en, show English labels. Store a stable value (e.g., English label or ISO code) in session.

The client must render a searchable dropdown for type: "country".

C) Client rendering

Based on type:

text → show the single bottom text box (existing).

chips → render inline options as buttons (from options).

country → render a searchable dropdown using the provided options.

Do not render blank bot bubbles. If prompt is falsy, don’t append a bubble—log an error instead.

After user submits:

If response has {error:true} → show that message and keep the same step.

If response has the next payload → show the new bot message and input widget.

If {done:true} → move to the assessment stage.

D) Validation

name_full: require at least two words.

email: simple regex.

Other steps: non-empty, or a valid option.

Acceptance checks

Answer name with “First Last” → immediately receive the email question (no blank bubble).

After valid email → see age band chips.

After age → country dropdown with full list and search; selecting a country advances to job_nature chips.

All following steps show the correct options/inputs and advance smoothly.

Language toggle still flips prompts/options AR/EN and keeps RTL/LTR.

No 404s; no blank bubbles.

Optional logging

Log each /api/intake/next response payload shape to the console while testing to confirm prompt/type/options are present.

Please implement the above fixes now, keeping changes focused in server/index.js and the existing client chat script only. Don’t add extra modules or flows. When done, ping me to test.